---
// Sticky date navigation with prev/next arrows
import fs from 'node:fs';
import path from 'node:path';

interface Props {
  currentDate: string;
  notebookId: string;
  isLatest?: boolean;
}

const { currentDate, notebookId, isLatest = false } = Astro.props;

// Load manifest to get available dates
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
let dates: string[] = [];
let latestDate = '';

if (fs.existsSync(manifestPath)) {
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  dates = Object.keys(manifest.dates || {}).sort().reverse();
  latestDate = manifest.latest_date || dates[0] || '';
}

// Find prev/next dates
const currentIndex = dates.indexOf(currentDate);
const prevDate = currentIndex < dates.length - 1 ? dates[currentIndex + 1] : null;
const nextDate = currentIndex > 0 ? dates[currentIndex - 1] : null;

// Build URLs
const base = import.meta.env.BASE_URL;
const buildUrl = (date: string | null) => {
  if (!date) return null;
  if (date === latestDate) {
    return `${base}notebooks/${notebookId}`;
  }
  return `${base}archive/${date}/${notebookId}`;
};

const prevUrl = buildUrl(prevDate);
const nextUrl = buildUrl(nextDate);

// Format date for display
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr + 'T00:00:00Z');
  return date.toLocaleDateString('en-US', {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    timeZone: 'UTC'
  });
};

const formatShortDate = (dateStr: string) => {
  const date = new Date(dateStr + 'T00:00:00Z');
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    timeZone: 'UTC'
  });
};
---

<div class="date-nav">
  <a
    href={prevUrl || '#'}
    class:list={['date-nav-arrow', 'prev', { disabled: !prevUrl }]}
    aria-label="Previous date"
    aria-disabled={!prevUrl}
  >
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
    {prevDate && <span class="date-nav-hint">{formatShortDate(prevDate)}</span>}
  </a>

  <div class="date-nav-current">
    <span class="date-nav-label">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
        <line x1="16" y1="2" x2="16" y2="6" />
        <line x1="8" y1="2" x2="8" y2="6" />
        <line x1="3" y1="10" x2="21" y2="10" />
      </svg>
      Data snapshot
    </span>
    <span class="date-nav-date">
      {formatDate(currentDate)}
      {isLatest && <span class="latest-badge">Latest</span>}
    </span>
  </div>

  <a
    href={nextUrl || '#'}
    class:list={['date-nav-arrow', 'next', { disabled: !nextUrl }]}
    aria-label="Next date"
    aria-disabled={!nextUrl}
  >
    {nextDate && <span class="date-nav-hint">{formatShortDate(nextDate)}</span>}
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </a>
</div>

<style>
  .date-nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.875rem 1.25rem;
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 2rem;
    position: sticky;
    top: 1rem;
    z-index: 40;
    backdrop-filter: blur(12px);
    transition: all 0.3s ease;
  }

  /* Subtle glow in dark mode */
  :global(.dark) .date-nav {
    background: oklch(0.14 0.018 260 / 90%);
    box-shadow:
      0 1px 2px oklch(0 0 0 / 20%),
      0 0 30px oklch(0.55 0.12 280 / 8%);
  }

  .date-nav-arrow {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 0.875rem;
    border-radius: var(--radius);
    color: var(--muted-foreground);
    text-decoration: none;
    font-size: 0.75rem;
    transition: all 0.2s ease;
    min-width: 90px;
    border: 1px solid transparent;
  }

  .date-nav-arrow.prev {
    justify-content: flex-start;
  }

  .date-nav-arrow.next {
    justify-content: flex-end;
  }

  .date-nav-arrow:not(.disabled):hover {
    background: var(--primary);
    color: var(--primary-foreground);
    border-color: var(--primary);
    transform: translateX(-2px);
  }

  .date-nav-arrow.next:not(.disabled):hover {
    transform: translateX(2px);
  }

  .date-nav-arrow.disabled {
    opacity: 0.25;
    cursor: not-allowed;
    pointer-events: none;
  }

  .date-nav-hint {
    font-family: var(--font-mono);
    font-size: 0.6875rem;
    letter-spacing: 0.02em;
  }

  .date-nav-current {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    flex: 1;
    text-align: center;
  }

  .date-nav-label {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-family: var(--font-mono);
    font-size: 0.625rem;
    color: var(--muted-foreground);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .date-nav-date {
    font-family: var(--font-serif);
    font-weight: 400;
    font-size: 1rem;
    color: var(--foreground);
    display: flex;
    align-items: center;
    gap: 0.625rem;
    letter-spacing: -0.01em;
  }

  .latest-badge {
    font-family: var(--font-mono);
    font-size: 0.5625rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding: 0.1875rem 0.5rem;
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    color: var(--primary-foreground);
    border-radius: 2rem;
    animation: pulse-glow 3s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% {
      box-shadow: 0 0 0 0 oklch(0.60 0.15 280 / 40%);
    }
    50% {
      box-shadow: 0 0 12px 2px oklch(0.60 0.15 280 / 30%);
    }
  }

  @media (max-width: 640px) {
    .date-nav-hint {
      display: none;
    }

    .date-nav-arrow {
      min-width: auto;
      padding: 0.5rem;
    }

    .date-nav-date {
      font-size: 0.875rem;
    }
  }
</style>
