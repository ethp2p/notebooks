---
import { NotebookIcon } from './NotebookIcon';
import { Icon } from './Icon';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Helper to convert YYYY-MM-DD to YYYYMMDD
const toCompactDate = (iso: string) => iso.replace(/-/g, '');

// Load notebooks config
const configPath = path.join(process.cwd(), 'config', 'notebooks.yaml');
const configContent = fs.readFileSync(configPath, 'utf-8');
const config = yaml.load(configContent) as {
  notebooks: Array<{
    id: string;
    title: string;
    description: string;
    icon?: string;
    order: number;
  }>;
};

// Load manifest for available dates
let manifest: { latest_date: string; dates: Record<string, unknown> } = { latest_date: '', dates: {} };
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
if (fs.existsSync(manifestPath)) {
  manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
}

const notebooks = config.notebooks.sort((a, b) => a.order - b.order);
const latestDate = manifest.latest_date || 'No data';
const historicalDates = Object.keys(manifest.dates || {})
  .filter(d => d !== manifest.latest_date)
  .sort((a, b) => b.localeCompare(a)); // Newest first

const currentPath = Astro.url.pathname;
const base = import.meta.env.BASE_URL;

// Helper to format dates nicely
const formatDate = (dateStr: string) => {
  const date = new Date(dateStr + 'T00:00:00Z');
  return date.toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    timeZone: 'UTC'
  });
};
---

<nav class="flex flex-col gap-8">
  <!-- Latest Section -->
  <div class="flex flex-col gap-2">
    <div class="flex items-center justify-between px-2 mb-1">
      <span class="font-mono text-[0.625rem] font-semibold uppercase tracking-widest text-muted-foreground">Latest</span>
      <span class="flex items-center gap-1.5 font-mono text-[0.5625rem] font-medium py-0.5 px-2 bg-muted  text-muted-foreground">
        <span class="w-1.5 h-1.5 bg-accent  animate-pulse"></span>
        {formatDate(latestDate)}
      </span>
    </div>
    <ul class="list-none p-0 m-0 flex flex-col gap-0.5">
      {notebooks.map((nb, index) => {
        const href = `${base}notebooks/${nb.id}`;
        const isActive = currentPath.includes(`/notebooks/${nb.id}`);
        return (
          <li class="animate-[slideInLeft_0.3s_ease-out_backwards]" style={`animation-delay: calc(${index} * 0.03s)`}>
            <a
              href={href}
              class:list={[
                'group relative flex items-center gap-2.5 py-2 px-2.5 text-muted-foreground no-underline  text-[0.8125rem] transition-all duration-200',
                'before:content-[\'\'] before:absolute before:left-0 before:top-1/2 before:w-[3px] before:h-0 before:bg-primary before: before:-translate-y-1/2 before:transition-all before:duration-200',
                'hover:text-foreground hover:bg-muted hover:before:h-1/2',
                isActive ? 'text-foreground bg-[var(--mauve-4)] font-medium before:!h-[60%]' : ''
              ]}
              title={nb.description}
            >
              <span class="flex items-center justify-center shrink-0 opacity-50 transition-all duration-200 group-hover:opacity-100 group-hover:text-primary group-[.active]:opacity-100 group-[.active]:text-primary">
                <NotebookIcon icon={nb.icon} size={14} />
              </span>
              <span class="flex-1 min-w-0 overflow-hidden text-ellipsis whitespace-nowrap">{nb.title}</span>
            </a>
          </li>
        );
      })}
    </ul>
  </div>

  <!-- Previous Snapshots Section -->
  {historicalDates.length > 0 && (
    <div class="flex flex-col gap-2">
      <div class="flex items-center justify-between px-2 mb-1">
        <span class="font-mono text-[0.625rem] font-semibold uppercase tracking-widest text-muted-foreground">Previous</span>
        <span class="font-mono text-[0.5625rem] font-medium text-muted-foreground opacity-70">{historicalDates.length} dates</span>
      </div>
      <ul class="list-none p-0 m-0 flex flex-col gap-0.5">
        {historicalDates.slice(0, 7).map((date, index) => {
          const compactDate = toCompactDate(date);
          const href = `${base}${compactDate}`;
          const isActive = currentPath.startsWith(`/${compactDate}`);
          return (
            <li class="animate-[slideInLeft_0.3s_ease-out_backwards]" style={`animation-delay: calc(${index} * 0.03s)`}>
              <a
                href={href}
                class:list={[
                  'group relative flex items-center gap-2.5 py-2 px-2.5 text-muted-foreground no-underline  text-[0.8125rem] transition-all duration-200',
                  'before:content-[\'\'] before:absolute before:left-0 before:top-1/2 before:w-[3px] before:h-0 before:bg-primary before: before:-translate-y-1/2 before:transition-all before:duration-200',
                  'hover:text-foreground hover:bg-muted hover:before:h-1/2',
                  isActive ? 'text-foreground bg-[var(--mauve-4)] font-medium before:!h-[60%]' : ''
                ]}
              >
                <span class="flex items-center justify-center shrink-0 opacity-50 transition-all duration-200 group-hover:opacity-100 group-hover:text-primary">
                  <Icon name="Calendar" size={14} client:load />
                </span>
                <span class="flex-1 min-w-0 overflow-hidden text-ellipsis whitespace-nowrap font-mono text-xs tracking-tight">{formatDate(date)}</span>
                <span class="font-mono text-[0.5625rem] text-muted-foreground opacity-60 py-0.5 px-1 bg-muted">{date.slice(0, 4)}</span>
              </a>
            </li>
          );
        })}
      </ul>
    </div>
  )}
</nav>
