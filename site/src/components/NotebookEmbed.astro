---
import fs from "node:fs";
import path from "node:path";
import CodeToggle from "./CodeToggle.astro";

interface Props {
    htmlPath: string;
    title: string;
}

const { htmlPath, title } = Astro.props;

// Read the pre-rendered HTML at build time
const fullPath = path.join(process.cwd(), "public", "rendered", htmlPath);

let content = "";
let error = "";
let headContent = "";

if (fs.existsSync(fullPath)) {
    const html = fs.readFileSync(fullPath, "utf-8");

    // Extract head content for styles
    const headMatch = html.match(/<head[^>]*>([\s\S]*?)<\/head>/i);
    if (headMatch) {
        // Extract only style tags from head
        const styleMatches = headMatch[1].match(
            /<style[^>]*>[\s\S]*?<\/style>/gi,
        );
        if (styleMatches) {
            headContent = styleMatches.join("\n");
        }
    }

    // Extract body content from the HTML
    const bodyMatch = html.match(/<body[^>]*>([\s\S]*)<\/body>/i);
    if (bodyMatch) {
        content = bodyMatch[1];

        // Remove Quarto navigation elements and duplicate title
        content = content
            .replace(
                /<nav[^>]*class="[^"]*quarto-secondary-nav[^"]*"[^>]*>[\s\S]*?<\/nav>/gi,
                "",
            )
            .replace(
                /<header[^>]*id="quarto-header"[^>]*>[\s\S]*?<\/header>/gi,
                "",
            )
            .replace(/<nav[^>]*id="quarto-sidebar"[^>]*>[\s\S]*?<\/nav>/gi, "")
            .replace(/<footer[^>]*>[\s\S]*?<\/footer>/gi, "")
            // Remove the Quarto-generated title (we show our own)
            .replace(
                /<header[^>]*id="title-block-header"[^>]*>[\s\S]*?<\/header>/gi,
                "",
            )
            .replace(
                /<h1[^>]*class="[^"]*title[^"]*"[^>]*>[\s\S]*?<\/h1>/gi,
                "",
            );
    } else {
        content = html;
    }
} else {
    error = `Notebook not found: ${htmlPath}`;
}
---

{
    error ? (
        <div class="error-container">
            <div class="error-icon">
                <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                >
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                </svg>
            </div>
            <h2>Error Loading Notebook</h2>
            <p>{error}</p>
        </div>
    ) : (
        <>
            <article class="notebook-content">
                <header class="notebook-header">
                    <h1 class="notebook-title">{title}</h1>
                    <div class="notebook-controls">
                        <CodeToggle />
                    </div>
                </header>
                <Fragment set:html={headContent} />
                <div class="notebook-body" set:html={content} />
            </article>
        </>
    )
}

<style is:global>
    @reference "../styles/global.css";

    .error-container {
        @apply p-10 rounded-lg text-center;
        background: oklch(0.95 0.03 25 / 50%);
        border: 1px solid oklch(0.85 0.08 25);
        color: oklch(0.45 0.15 25);
    }

    :global(.dark) .error-container {
        background: oklch(0.2 0.05 25 / 30%);
        border-color: oklch(0.4 0.12 25);
        color: oklch(0.75 0.12 25);
    }

    .error-icon {
        @apply inline-flex mb-4 opacity-70;
    }

    .error-container h2 {
        @apply font-serif text-xl font-normal mb-2;
    }

    .error-container p {
        @apply font-mono text-sm opacity-80;
    }

    /* Notebook header */
    .notebook-header {
        @apply mb-10 pb-8 border-b border-border;
        animation: fadeUp 0.5s ease-out;
    }

    .notebook-title {
        @apply font-serif text-4xl font-normal text-foreground m-0 mb-5 leading-tight;
        letter-spacing: -0.03em;
    }

    :global(.dark) .notebook-title {
        background: linear-gradient(135deg, var(--foreground) 0%, var(--mauve-11) 100%);
        @apply bg-clip-text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .notebook-controls {
        @apply flex items-center gap-4;
    }

    /* Section headings */
    .notebook-content h2 {
        @apply font-serif font-normal text-foreground relative pb-2.5 border-b border-border;
        font-size: 1.625rem;
        margin: 3.5rem 0 1.5rem 0;
        letter-spacing: -0.02em;
        line-height: 1.25;
    }

    .notebook-content h2::before {
        @apply absolute bottom-[-1px] left-0 w-12 h-0.5 bg-primary;
        content: "";
    }

    .notebook-content h2:first-of-type {
        @apply mt-0;
    }

    .notebook-content h3 {
        @apply font-serif text-xl font-normal text-foreground;
        margin: 2.5rem 0 1rem 0;
        letter-spacing: -0.01em;
        line-height: 1.35;
    }

    .notebook-content h4 {
        @apply font-sans text-base font-semibold text-foreground;
        margin: 2rem 0 0.75rem 0;
    }

    /* Paragraphs and text */
    .notebook-content p {
        @apply mb-5 leading-relaxed text-foreground;
        margin-top: 0;
    }

    .notebook-content a {
        @apply text-primary underline transition-all duration-200;
        text-decoration-color: oklch(0.6 0.15 280 / 40%);
        text-underline-offset: 3px;
    }

    .notebook-content a:hover {
        @apply text-accent;
        text-decoration-color: var(--accent);
    }

    /* Lists */
    .notebook-content ul,
    .notebook-content ol {
        @apply mb-5 pl-7;
        margin-top: 0;
    }

    .notebook-content li {
        @apply mb-2;
        line-height: 1.7;
    }

    .notebook-content li::marker {
        @apply text-primary;
    }

    /* Syntax highlighting - Technical Observatory theme */
    .sourceCode {
        @apply bg-muted border border-border rounded-lg overflow-x-auto relative;
        font-size: 0.8125rem;
        line-height: 1.65;
    }

    :global(.dark) .sourceCode {
        background: oklch(0.14 0.02 260) !important;
        border-color: oklch(0.25 0.02 260);
    }

    .sourceCode pre {
        @apply m-0 py-5 px-6 bg-transparent;
    }

    .sourceCode code {
        @apply font-mono text-sm bg-transparent p-0;
    }

    /* Token colors - Light mode */
    .sourceCode .kw {
        color: oklch(0.5 0.2 330);
        font-weight: 500;
    } /* Keywords - magenta */
    .sourceCode .dt {
        color: oklch(0.45 0.18 260);
    } /* Data types - purple */
    .sourceCode .dv {
        color: oklch(0.5 0.15 180);
    } /* Decimal values - teal */
    .sourceCode .bn {
        color: oklch(0.5 0.15 180);
    } /* Base N */
    .sourceCode .fl {
        color: oklch(0.5 0.15 180);
    } /* Float */
    .sourceCode .ch {
        color: oklch(0.45 0.12 145);
    } /* Char - green */
    .sourceCode .st {
        color: oklch(0.45 0.12 145);
    } /* String */
    .sourceCode .co {
        color: var(--muted-foreground);
        font-style: italic;
    } /* Comment */
    .sourceCode .ot {
        color: oklch(0.5 0.2 330);
    } /* Other */
    .sourceCode .al {
        color: oklch(0.55 0.2 25);
        font-weight: bold;
    } /* Alert - red */
    .sourceCode .fu {
        color: oklch(0.5 0.18 280);
    } /* Function - purple */
    .sourceCode .er {
        color: oklch(0.55 0.2 25);
        font-weight: bold;
    } /* Error */
    .sourceCode .wa {
        color: oklch(0.55 0.15 80);
        font-style: italic;
    } /* Warning - gold */
    .sourceCode .cn {
        color: oklch(0.5 0.15 180);
    } /* Constant */
    .sourceCode .sc {
        color: oklch(0.45 0.12 145);
    } /* Special char */
    .sourceCode .vs {
        color: oklch(0.45 0.12 145);
    } /* Verbatim string */
    .sourceCode .ss {
        color: oklch(0.45 0.12 145);
    } /* Special string */
    .sourceCode .im {
        color: oklch(0.5 0.2 330);
    } /* Import */
    .sourceCode .va {
        color: var(--foreground);
    } /* Variable */
    .sourceCode .cf {
        color: oklch(0.5 0.2 330);
        font-weight: 500;
    } /* Control flow */
    .sourceCode .op {
        color: var(--foreground);
    } /* Operator */
    .sourceCode .bu {
        color: oklch(0.45 0.18 260);
    } /* Built-in */
    .sourceCode .ex {
        color: oklch(0.5 0.18 280);
    } /* Extension */
    .sourceCode .pp {
        color: oklch(0.5 0.2 330);
    } /* Preprocessor */
    .sourceCode .at {
        color: oklch(0.45 0.18 260);
    } /* Attribute */
    .sourceCode .do {
        color: var(--muted-foreground);
        font-style: italic;
    } /* Documentation */
    .sourceCode .an {
        color: var(--muted-foreground);
        font-weight: bold;
        font-style: italic;
    } /* Annotation */
    .sourceCode .cv {
        color: var(--muted-foreground);
        font-weight: bold;
        font-style: italic;
    } /* Comment var */
    .sourceCode .in {
        color: var(--muted-foreground);
        font-weight: bold;
        font-style: italic;
    } /* Information */

    /* Dark mode token colors */
    :global(.dark) .sourceCode .kw {
        color: oklch(0.75 0.18 330);
    }
    :global(.dark) .sourceCode .dt {
        color: oklch(0.72 0.15 260);
    }
    :global(.dark) .sourceCode .dv {
        color: oklch(0.75 0.14 180);
    }
    :global(.dark) .sourceCode .bn {
        color: oklch(0.75 0.14 180);
    }
    :global(.dark) .sourceCode .fl {
        color: oklch(0.75 0.14 180);
    }
    :global(.dark) .sourceCode .ch {
        color: oklch(0.72 0.12 145);
    }
    :global(.dark) .sourceCode .st {
        color: oklch(0.72 0.12 145);
    }
    :global(.dark) .sourceCode .fu {
        color: oklch(0.75 0.15 280);
    }
    :global(.dark) .sourceCode .al {
        color: oklch(0.72 0.18 25);
    }
    :global(.dark) .sourceCode .er {
        color: oklch(0.72 0.18 25);
    }
    :global(.dark) .sourceCode .wa {
        color: oklch(0.78 0.14 80);
    }
    :global(.dark) .sourceCode .bu {
        color: oklch(0.72 0.15 260);
    }
    :global(.dark) .sourceCode .ex {
        color: oklch(0.75 0.15 280);
    }

    /* Code folding - subtle, minimal style */
    .notebook-content details.code-fold {
        @apply mb-6;
    }

    .notebook-content details.code-fold > summary {
        @apply cursor-pointer font-mono text-muted-foreground p-0 bg-transparent border-none inline-flex items-center gap-0 select-none list-none opacity-60;
        font-size: 0.6875rem;
        transition: color 0.15s ease;
    }

    .notebook-content details.code-fold > summary:hover {
        @apply text-foreground opacity-100;
    }

    .notebook-content details.code-fold > summary::marker,
    .notebook-content details.code-fold > summary::-webkit-details-marker {
        @apply hidden;
    }

    .notebook-content details.code-fold > summary::before {
        content: "â–¸";
        font-size: 0.625rem;
        transition: transform 0.15s ease;
    }

    .notebook-content details.code-fold[open] > summary::before {
        @apply rotate-90;
    }

    .notebook-content details.code-fold[open] > summary {
        @apply mb-2;
    }

    /* Charts */
    .notebook-content .js-plotly-plot,
    .notebook-content .plotly-graph-div {
        @apply w-full my-6 rounded-lg overflow-hidden;
    }

    .notebook-content .vega-embed {
        @apply w-full my-6;
    }

    /* Code cells */
    .notebook-content .cell {
        @apply mb-10;
    }

    .notebook-content .cell-code {
        @apply mb-4;
    }

    /* Cell output */
    .notebook-content .cell-output-display {
        @apply mt-5;
    }

    /* Tables */
    .notebook-content table {
        @apply w-full border-collapse my-6 text-sm border border-border rounded-lg overflow-hidden;
    }

    .notebook-content th,
    .notebook-content td {
        @apply py-3 px-4 text-left border-b border-border;
    }

    .notebook-content th {
        @apply font-mono font-semibold uppercase tracking-wider bg-muted text-muted-foreground;
        font-size: 0.6875rem;
    }

    .notebook-content td {
        @apply font-mono text-sm;
    }

    .notebook-content tr:last-child td {
        @apply border-b-0;
    }

    .notebook-content tr:hover td {
        background: var(--mauve-2);
    }

    :global(.dark) .notebook-content tr:hover td {
        background: oklch(0.18 0.02 260);
    }

    /* Hide Quarto elements */
    .notebook-content .code-copy-button {
        @apply hidden;
    }

    /* Line numbers */
    .sourceCode pre code span.line-number {
        @apply text-muted-foreground mr-5 select-none opacity-50;
    }

    /* Blockquotes */
    .notebook-content blockquote {
        @apply my-8 py-5 px-6 border-l-[3px] border-l-primary rounded-r-lg;
        background: var(--mauve-2);
    }

    :global(.dark) .notebook-content blockquote {
        background: oklch(0.16 0.02 260);
    }

    .notebook-content blockquote p:last-child {
        @apply mb-0;
    }

    /* Inline code */
    .notebook-content :not(pre) > code {
        @apply bg-muted py-0.5 px-2 rounded-lg font-mono text-primary;
        font-size: 0.875em;
    }

    :global(.dark) .notebook-content :not(pre) > code {
        background: oklch(0.2 0.02 260);
    }

    /* Images */
    .notebook-content img {
        @apply max-w-full h-auto rounded-lg;
    }

    /* Horizontal rules */
    .notebook-content hr {
        @apply border-none border-t border-border my-12;
    }

    /* Animation for cells appearing */
    @keyframes cellReveal {
        from {
            opacity: 0;
            transform: translateY(12px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .notebook-content .cell {
        animation: cellReveal 0.5s ease-out backwards;
    }

    .notebook-content .cell:nth-child(1) { animation-delay: 0.1s; }
    .notebook-content .cell:nth-child(2) { animation-delay: 0.15s; }
    .notebook-content .cell:nth-child(3) { animation-delay: 0.2s; }
    .notebook-content .cell:nth-child(4) { animation-delay: 0.25s; }
    .notebook-content .cell:nth-child(5) { animation-delay: 0.3s; }
</style>
