---
// Code toggle component - shows a checkbox to expand/collapse all code blocks
// Persists state to localStorage
---

<div class="inline-block">
  <label class="group inline-flex items-center gap-2 cursor-pointer text-[0.8125rem] text-muted-foreground select-none py-1.5 px-3 bg-muted rounded-md transition-all duration-150 hover:text-foreground hover:bg-[var(--mauve-3)]">
    <input type="checkbox" id="show-all-code" class="peer absolute opacity-0 cursor-pointer h-0 w-0" />
    <span class="relative h-3.5 w-3.5 bg-background border border-border rounded shrink-0 transition-all duration-150 group-hover:border-[var(--mauve-8)] peer-checked:bg-foreground peer-checked:border-foreground after:content-[''] after:absolute after:hidden after:left-1 after:top-px after:w-1 after:h-[0.45rem] after:border-background after:border-r-[1.5px] after:border-b-[1.5px] after:rotate-45 peer-checked:after:block"></span>
    <span class="font-sans">Show all code</span>
  </label>
</div>

<script>
  const STORAGE_KEY = 'notebook-show-all-code';

  function initCodeToggle() {
    const checkbox = document.getElementById('show-all-code') as HTMLInputElement;
    if (!checkbox) return;

    // Get all code details elements
    const getCodeBlocks = () => document.querySelectorAll('.notebook-content details.code-fold');

    // Load saved preference
    const savedState = localStorage.getItem(STORAGE_KEY);
    if (savedState === 'true') {
      checkbox.checked = true;
      // Apply saved state to code blocks
      const codeBlocks = getCodeBlocks();
      codeBlocks.forEach(block => {
        block.setAttribute('open', '');
      });
    }

    checkbox.addEventListener('change', () => {
      const codeBlocks = getCodeBlocks();
      codeBlocks.forEach(block => {
        if (checkbox.checked) {
          block.setAttribute('open', '');
        } else {
          block.removeAttribute('open');
        }
      });
      // Save preference
      localStorage.setItem(STORAGE_KEY, checkbox.checked.toString());
    });

    // Update checkbox state based on current state of code blocks
    const updateCheckboxState = () => {
      const codeBlocks = getCodeBlocks();
      if (codeBlocks.length === 0) return;

      const allOpen = Array.from(codeBlocks).every(block => block.hasAttribute('open'));
      checkbox.checked = allOpen;
      // Don't save on manual individual toggles - only on bulk toggle
    };

    // Listen for individual toggle changes
    document.addEventListener('toggle', (e) => {
      if ((e.target as HTMLElement)?.closest('.code-fold')) {
        updateCheckboxState();
      }
    }, true);
  }

  // Run on initial load
  initCodeToggle();

  // Re-run on Astro page transitions
  document.addEventListener('astro:page-load', initCodeToggle);
</script>
