---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import NotebookEmbed from '../../../components/NotebookEmbed.astro';
import DateNav from '../../../components/DateNav.astro';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load notebooks config
const configPath = path.join(process.cwd(), 'config', 'notebooks.yaml');
const configContent = fs.readFileSync(configPath, 'utf-8');
const config = yaml.load(configContent) as {
  notebooks: Array<{
    id: string;
    title: string;
    description: string;
    source: string;
    order: number;
  }>;
};

// Load manifest
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
let manifest: { latest_date?: string; dates: Record<string, Record<string, { html_path: string }>> } = { dates: {} };
if (fs.existsSync(manifestPath)) {
  manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
}

export function getStaticPaths() {
  const configPath = path.join(process.cwd(), 'config', 'notebooks.yaml');
  const configContent = fs.readFileSync(configPath, 'utf-8');
  const config = yaml.load(configContent) as { notebooks: Array<{ id: string }> };

  const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
  if (!fs.existsSync(manifestPath)) {
    return [];
  }
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));

  const paths: Array<{ params: { date: string; notebook: string } }> = [];

  for (const date of Object.keys(manifest.dates || {})) {
    const dateData = manifest.dates[date];
    for (const nb of config.notebooks) {
      if (dateData[nb.id]) {
        paths.push({
          params: { date, notebook: nb.id },
        });
      }
    }
  }

  return paths;
}

const { date, notebook: notebookId } = Astro.params;
const notebook = config.notebooks.find(nb => nb.id === notebookId);

if (!notebook) {
  return Astro.redirect('/404');
}

const dateData = manifest.dates[date!] || {};
const notebookData = dateData[notebook.id];

if (!notebookData) {
  return Astro.redirect(`/archive/${date}`);
}

const htmlPath = notebookData.html_path || `archive/${date}/${notebook.id}.html`;
const isLatest = date === manifest.latest_date;
---

<BaseLayout title={`${notebook.title} - ${date}`} description={notebook.description} showToc={true}>
  <DateNav currentDate={date!} notebookId={notebook.id} isLatest={isLatest} />
  <NotebookEmbed htmlPath={htmlPath} title={notebook.title} />
</BaseLayout>
