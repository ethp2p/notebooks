---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import DatePicker from '../../../components/DatePicker.astro';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load notebooks config
const configPath = path.join(process.cwd(), 'config', 'notebooks.yaml');
const configContent = fs.readFileSync(configPath, 'utf-8');
const config = yaml.load(configContent) as {
  notebooks: Array<{
    id: string;
    title: string;
    description: string;
    order: number;
  }>;
};

// Load manifest
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
let manifest: { dates: Record<string, Record<string, unknown>> } = { dates: {} };
if (fs.existsSync(manifestPath)) {
  manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
}

export function getStaticPaths() {
  const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
  if (!fs.existsSync(manifestPath)) {
    return [];
  }
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  const dates = Object.keys(manifest.dates || {});

  return dates.map(date => ({
    params: { date },
  }));
}

const { date } = Astro.params;
const dateData = manifest.dates[date!] || {};
const notebooks = config.notebooks.sort((a, b) => a.order - b.order);

// Filter to notebooks that have been rendered for this date
const availableNotebooks = notebooks.filter(nb => dateData[nb.id]);
---

<BaseLayout title={`Archive: ${date}`}>
  <div class="max-w-3xl">
    <div class="mb-4 text-sm text-[var(--muted-foreground)]">
      <a href="/" class="hover:text-[var(--foreground)]">Home</a>
      <span class="mx-2">/</span>
      <a href="/archive" class="hover:text-[var(--foreground)]">Archive</a>
      <span class="mx-2">/</span>
      <span>{date}</span>
    </div>

    <h1>Archive: {date}</h1>

    <div class="mb-8 max-w-xs">
      <DatePicker currentDate={date} />
    </div>

    <section>
      <h2>Notebooks</h2>
      {availableNotebooks.length > 0 ? (
        <div class="grid gap-4">
          {availableNotebooks.map(nb => (
            <a
              href={`/archive/${date}/${nb.id}`}
              class="block p-4 border border-[var(--border)] rounded-lg hover:border-[var(--mauve-8)] hover:bg-[var(--mauve-2)] transition-colors no-underline"
            >
              <h3 class="text-lg font-medium text-[var(--foreground)] mb-1 mt-0">
                {nb.title}
              </h3>
              <p class="text-sm text-[var(--muted-foreground)] m-0">
                {nb.description}
              </p>
            </a>
          ))}
        </div>
      ) : (
        <p class="text-[var(--muted-foreground)]">
          No notebooks available for this date.
        </p>
      )}
    </section>
  </div>
</BaseLayout>
