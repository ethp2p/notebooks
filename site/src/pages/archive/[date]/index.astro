---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Icon from '../../../components/Icon.astro';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load notebooks config
const configPath = path.join(process.cwd(), 'config', 'notebooks.yaml');
const configContent = fs.readFileSync(configPath, 'utf-8');
const config = yaml.load(configContent) as {
  notebooks: Array<{
    id: string;
    title: string;
    description: string;
    icon?: string;
    order: number;
  }>;
};

// Load manifest
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
let manifest: { dates: Record<string, Record<string, unknown>> } = { dates: {} };
if (fs.existsSync(manifestPath)) {
  manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
}

export function getStaticPaths() {
  const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
  if (!fs.existsSync(manifestPath)) {
    return [];
  }
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  const dates = Object.keys(manifest.dates || {});

  return dates.map(date => ({
    params: { date },
  }));
}

const { date } = Astro.params;
const dateData = manifest.dates[date!] || {};
const notebooks = config.notebooks.sort((a, b) => a.order - b.order);

// Filter to notebooks that have been rendered for this date
const availableNotebooks = notebooks.filter(nb => dateData[nb.id]);

// Get all dates for navigation
const allDates = Object.keys(manifest.dates).sort((a, b) => b.localeCompare(a));
const currentIndex = allDates.indexOf(date!);
const prevDate = currentIndex < allDates.length - 1 ? allDates[currentIndex + 1] : null;
const nextDate = currentIndex > 0 ? allDates[currentIndex - 1] : null;

// Format date for display
const dateObj = new Date(date + 'T00:00:00Z');
const formattedDate = dateObj.toLocaleDateString('en-US', {
  weekday: 'long',
  month: 'long',
  day: 'numeric',
  year: 'numeric',
  timeZone: 'UTC'
});
const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'UTC' });
const monthShort = dateObj.toLocaleDateString('en-US', { month: 'short', timeZone: 'UTC' });
const dayNum = dateObj.getDate();
const year = dateObj.getFullYear();

---

<BaseLayout title={`Archive: ${date}`}>
  <div class="archive-date-page">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <a href="/" class="breadcrumb-link">
        <Icon name="Home" size={14} />
        <span>Home</span>
      </a>
      <span class="breadcrumb-sep">/</span>
      <a href="/archive" class="breadcrumb-link">Archive</a>
      <span class="breadcrumb-sep">/</span>
      <span class="breadcrumb-current">{date}</span>
    </nav>

    <!-- Header -->
    <header class="date-header">
      <div class="date-display">
        <div class="date-calendar">
          <span class="date-month">{monthShort}</span>
          <span class="date-day">{dayNum}</span>
          <span class="date-year">{year}</span>
        </div>
        <div class="date-info">
          <span class="date-weekday">{dayOfWeek}</span>
          <h1 class="date-title">Snapshot Archive</h1>
          <p class="date-subtitle">{formattedDate}</p>
        </div>
      </div>

    </header>

    <!-- Stats bar -->
    <div class="stats-bar">
      <div class="stat">
        <span class="stat-value">{availableNotebooks.length}</span>
        <span class="stat-label">Notebooks</span>
      </div>
      <div class="stat-divider"></div>
      <div class="stat">
        <span class="stat-value">{date}</span>
        <span class="stat-label">Snapshot Date</span>
      </div>
    </div>

    <!-- Navigation arrows -->
    <div class="date-nav">
      {prevDate ? (
        <a href={`/archive/${prevDate}`} class="nav-arrow nav-prev">
          <Icon name="ChevronLeft" size={16} />
          <span class="nav-label">
            <span class="nav-hint">Previous</span>
            <span class="nav-date">{prevDate}</span>
          </span>
        </a>
      ) : <div class="nav-placeholder"></div>}

      {nextDate ? (
        <a href={`/archive/${nextDate}`} class="nav-arrow nav-next">
          <span class="nav-label">
            <span class="nav-hint">Next</span>
            <span class="nav-date">{nextDate}</span>
          </span>
          <Icon name="ChevronRight" size={16} />
        </a>
      ) : <div class="nav-placeholder"></div>}
    </div>

    <!-- Notebooks section -->
    <section class="notebooks-section">
      <h2 class="section-title">
        <span class="section-title-text">Available Notebooks</span>
        <span class="section-title-line"></span>
      </h2>

      {availableNotebooks.length > 0 ? (
        <div class="notebooks-grid">
          {availableNotebooks.map((nb, index) => (
            <a
              href={`/archive/${date}/${nb.id}`}
              class="notebook-card"
              style={`--delay: ${index * 0.08}s`}
            >
              <div class="notebook-icon">
                <Icon name={nb.icon || 'FileText'} size={24} />
              </div>
              <div class="notebook-content">
                <h3 class="notebook-title">{nb.title}</h3>
                <p class="notebook-description">{nb.description}</p>
              </div>
              <div class="notebook-arrow">
                <Icon name="ArrowRight" size={18} />
              </div>
              <div class="notebook-glow"></div>
            </a>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <div class="empty-icon">
            <Icon name="FilePlus" size={48} strokeWidth={1} />
          </div>
          <h3 class="empty-title">No Notebooks Available</h3>
          <p class="empty-text">No analysis notebooks have been rendered for this date.</p>
          <a href="/archive" class="empty-link">Browse other dates</a>
        </div>
      )}
    </section>

    <!-- Back link -->
    <div class="back-section">
      <a href="/archive" class="back-link">
        <Icon name="ArrowLeft" size={16} />
        <span>Back to Archive</span>
      </a>
    </div>
  </div>
</BaseLayout>

<style>
  @reference "../../../styles/global.css";

  .archive-date-page {
    @apply max-w-3xl;
    animation: fadeUp 0.5s ease-out;
  }

  /* Breadcrumb */
  .breadcrumb {
    @apply flex items-center gap-2 mb-8 font-mono text-sm;
  }

  .breadcrumb-link {
    @apply flex items-center gap-1.5 text-muted-foreground no-underline transition-colors duration-200;
  }

  .breadcrumb-link:hover {
    @apply text-foreground;
  }

  .breadcrumb-sep {
    @apply text-border;
  }

  .breadcrumb-current {
    @apply text-foreground font-medium;
  }

  /* Header */
  .date-header {
    @apply mb-8 pb-8;
  }

  .date-display {
    @apply flex items-center gap-6;
  }

  .date-calendar {
    @apply flex flex-col items-center justify-center w-20 h-24  border-2 border-primary bg-primary/5;
    animation: fadeUp 0.4s ease-out 0.1s backwards;
  }

  :global(.dark) .date-calendar {
    @apply bg-primary/10;
  }

  .date-month {
    @apply font-mono text-xs font-bold uppercase tracking-wider text-primary;
  }

  .date-day {
    @apply font-serif text-3xl font-normal text-foreground leading-none -tracking-tight;
  }

  .date-year {
    @apply font-mono text-xs text-muted-foreground;
  }

  .date-info {
    @apply flex flex-col;
    animation: fadeUp 0.4s ease-out 0.15s backwards;
  }

  .date-weekday {
    @apply font-mono text-xs font-semibold uppercase tracking-widest text-primary mb-1;
  }

  .date-title {
    @apply font-serif text-3xl font-normal text-foreground m-0 mb-1 leading-tight -tracking-wide;
  }

  .date-subtitle {
    @apply font-sans text-sm text-muted-foreground m-0;
  }

  /* Stats bar */
  .stats-bar {
    @apply flex items-center gap-6 mb-6 py-4 px-6  bg-muted/50 border border-border;
    animation: fadeUp 0.4s ease-out 0.25s backwards;
  }

  .stat {
    @apply flex items-baseline gap-2;
  }

  .stat-value {
    @apply font-mono text-lg font-semibold text-foreground;
  }

  .stat-label {
    @apply font-mono text-xs uppercase tracking-wider text-muted-foreground;
  }

  .stat-divider {
    @apply w-px h-6 bg-border;
  }

  /* Date navigation */
  .date-nav {
    @apply flex justify-between items-center gap-4 mb-10;
    animation: fadeUp 0.4s ease-out 0.3s backwards;
  }

  .nav-arrow {
    @apply flex items-center gap-2 py-2 px-3  text-muted-foreground no-underline transition-all duration-200;
  }

  .nav-arrow:hover {
    @apply text-foreground bg-muted;
  }

  .nav-prev {
    @apply pr-4;
  }

  .nav-next {
    @apply pl-4 text-right;
  }

  .nav-label {
    @apply flex flex-col;
  }

  .nav-hint {
    @apply text-xs uppercase tracking-wider opacity-60;
  }

  .nav-date {
    @apply font-mono text-sm;
  }

  .nav-placeholder {
    @apply w-32;
  }

  /* Section */
  .notebooks-section {
    @apply mb-12;
    animation: fadeUp 0.4s ease-out 0.35s backwards;
  }

  .section-title {
    @apply flex items-center gap-4 font-serif text-xl font-normal text-foreground m-0 mb-6;
  }

  .section-title-text {
    @apply shrink-0;
  }

  .section-title-line {
    @apply flex-1 h-px bg-border;
  }

  /* Notebooks grid */
  .notebooks-grid {
    @apply flex flex-col gap-3;
  }

  .notebook-card {
    @apply relative flex items-center gap-5 p-5  border border-border bg-card no-underline transition-all duration-250 overflow-hidden;
    animation: fadeUp 0.4s ease-out calc(0.4s + var(--delay)) backwards;
  }

  .notebook-card:hover {
    @apply border-primary -translate-y-0.5;
    box-shadow: 0 8px 30px oklch(0 0 0 / 8%);
  }

  :global(.dark) .notebook-card:hover {
    @apply bg-[oklch(0.16_0.02_260)];
    box-shadow: 0 8px 30px oklch(0.55 0.12 280 / 15%);
  }

  .notebook-icon {
    @apply flex items-center justify-center w-12 h-12  bg-primary/10 text-primary shrink-0 transition-all duration-250;
  }

  .notebook-card:hover .notebook-icon {
    @apply bg-primary text-primary-foreground scale-110;
  }

  .notebook-content {
    @apply flex-1 min-w-0;
  }

  .notebook-title {
    @apply font-serif text-lg font-normal text-foreground m-0 mb-1 leading-snug;
  }

  .notebook-description {
    @apply text-sm text-muted-foreground m-0 leading-relaxed line-clamp-2;
  }

  .notebook-arrow {
    @apply flex items-center justify-center w-10 h-10  text-muted-foreground opacity-0 -translate-x-2 transition-all duration-250;
  }

  .notebook-card:hover .notebook-arrow {
    @apply opacity-100 translate-x-0 text-primary;
  }

  .notebook-glow {
    @apply absolute inset-0 opacity-0 transition-opacity duration-300 pointer-events-none;
    background: radial-gradient(circle at 50% 50%, oklch(0.6 0.15 280 / 8%) 0%, transparent 70%);
  }

  .notebook-card:hover .notebook-glow {
    @apply opacity-100;
  }

  /* Empty state */
  .empty-state {
    @apply text-center py-16 px-8  bg-muted/50 border border-border;
  }

  .empty-icon {
    @apply inline-flex text-muted-foreground opacity-40 mb-6;
  }

  .empty-title {
    @apply font-serif text-xl font-normal text-foreground m-0 mb-2;
  }

  .empty-text {
    @apply text-sm text-muted-foreground m-0 mb-6;
  }

  .empty-link {
    @apply inline-flex items-center gap-2 font-mono text-sm text-primary no-underline transition-colors duration-200;
  }

  .empty-link:hover {
    @apply text-accent underline;
  }

  /* Back section */
  .back-section {
    @apply pt-8 border-t border-border;
    animation: fadeUp 0.4s ease-out 0.5s backwards;
  }

  .back-link {
    @apply inline-flex items-center gap-2 font-mono text-sm text-muted-foreground no-underline transition-colors duration-200;
  }

  .back-link:hover {
    @apply text-foreground;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .date-display {
      @apply gap-4;
    }

    .date-calendar {
      @apply w-16 h-20;
    }

    .date-day {
      @apply text-2xl;
    }

    .date-title {
      @apply text-2xl;
    }

    .stats-bar {
      @apply flex-col items-start gap-3 px-4 py-3;
    }

    .stat-divider {
      @apply w-full h-px;
    }

    .date-nav {
      @apply flex-col gap-2;
    }

    .nav-arrow {
      @apply w-full justify-between;
    }

    .nav-prev, .nav-next {
      @apply px-4;
    }

    .nav-placeholder {
      @apply hidden;
    }

    .notebook-card {
      @apply p-4 gap-4;
    }

    .notebook-icon {
      @apply w-10 h-10;
    }
  }
</style>
