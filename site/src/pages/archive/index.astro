---
import BaseLayout from '../../layouts/BaseLayout.astro';
import fs from 'node:fs';
import path from 'node:path';

// Load manifest for available dates
let dates: string[] = [];
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
if (fs.existsSync(manifestPath)) {
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  dates = Object.keys(manifest.dates || {}).sort((a, b) => b.localeCompare(a));
}

const formatDate = (dateStr: string) => {
  const date = new Date(dateStr + 'T00:00:00Z');
  return date.toLocaleDateString('en-US', {
    weekday: 'short',
    month: 'short',
    day: 'numeric',
    year: 'numeric',
    timeZone: 'UTC'
  });
};

// Group dates by month
const groupedDates = dates.reduce((acc, date) => {
  const month = date.slice(0, 7); // YYYY-MM
  if (!acc[month]) acc[month] = [];
  acc[month].push(date);
  return acc;
}, {} as Record<string, string[]>);

const formatMonth = (monthStr: string) => {
  const date = new Date(monthStr + '-01T00:00:00Z');
  return date.toLocaleDateString('en-US', {
    month: 'long',
    year: 'numeric',
    timeZone: 'UTC'
  });
};
---

<BaseLayout title="Archive">
  <div class="max-w-3xl">
    <header class="mb-12 animate-[fadeUp_0.5s_ease-out]">
      <h1 class="font-serif text-4xl font-normal -tracking-wide m-0 mb-4 max-sm:text-3xl">Historical Archive</h1>
      <p class="text-[1.0625rem] leading-relaxed text-muted-foreground max-w-xl mb-6">
        Browse all historical notebook snapshots. Each date contains a complete set of analysis
        notebooks from that day's data.
      </p>
      <div class="flex gap-8">
        <div class="flex flex-col gap-0.5">
          <span class="font-mono text-2xl font-semibold text-primary">{dates.length}</span>
          <span class="font-mono text-[0.6875rem] uppercase tracking-widest text-muted-foreground">Snapshots</span>
        </div>
        <div class="flex flex-col gap-0.5">
          <span class="font-mono text-2xl font-semibold text-primary">{Object.keys(groupedDates).length}</span>
          <span class="font-mono text-[0.6875rem] uppercase tracking-widest text-muted-foreground">Months</span>
        </div>
      </div>
    </header>

    {dates.length > 0 ? (
      <div class="flex flex-col gap-10">
        {Object.entries(groupedDates).map(([month, monthDates]) => (
          <section class="animate-[fadeUp_0.5s_ease-out_backwards]">
            <h2 class="font-serif text-xl font-normal -tracking-tight m-0 mb-4 pb-3 border-b border-border text-foreground">{formatMonth(month)}</h2>
            <div class="grid grid-cols-[repeat(auto-fill,minmax(200px,1fr))] gap-3 max-sm:grid-cols-1">
              {monthDates.map((date, index) => (
                <a
                  href={`/archive/${date}`}
                  class="group flex items-center gap-3.5 py-3.5 px-4 bg-card border border-border rounded-lg no-underline transition-all duration-200 animate-[fadeUp_0.3s_ease-out_backwards] hover:border-primary hover:-translate-y-0.5 hover:shadow-[0_4px_12px_oklch(0_0_0/8%)] dark:hover:bg-[oklch(0.16_0.02_260)] dark:hover:shadow-[0_4px_20px_oklch(0.55_0.12_280/15%)]"
                  style={`animation-delay: calc(${index} * 0.02s)`}
                >
                  <div class="font-mono text-xl font-semibold text-foreground w-10 text-center">
                    {new Date(date + 'T00:00:00Z').getDate()}
                  </div>
                  <div class="flex-1 flex flex-col min-w-0">
                    <span class="text-xs text-muted-foreground uppercase tracking-wide">
                      {new Date(date + 'T00:00:00Z').toLocaleDateString('en-US', { weekday: 'short', timeZone: 'UTC' })}
                    </span>
                    <span class="font-mono text-[0.6875rem] text-muted-foreground opacity-70">{date}</span>
                  </div>
                  <svg class="text-muted-foreground opacity-0 -translate-x-1 transition-all duration-200 group-hover:opacity-100 group-hover:translate-x-0 group-hover:text-primary" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                  </svg>
                </a>
              ))}
            </div>
          </section>
        ))}
      </div>
    ) : (
      <div class="text-center py-16 px-8 bg-muted rounded-lg">
        <div class="text-muted-foreground opacity-50 mb-6">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
            <line x1="16" y1="2" x2="16" y2="6" />
            <line x1="8" y1="2" x2="8" y2="6" />
            <line x1="3" y1="10" x2="21" y2="10" />
          </svg>
        </div>
        <h2 class="font-serif text-xl font-normal m-0 mb-2">No Historical Data</h2>
        <p class="text-sm text-muted-foreground m-0">Run the render pipeline to generate notebook archives.</p>
      </div>
    )}
  </div>
</BaseLayout>
