---
import BaseLayout from '../layouts/BaseLayout.astro';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load notebooks config
const configPath = path.join(process.cwd(), 'config', 'notebooks.yaml');
const configContent = fs.readFileSync(configPath, 'utf-8');
const config = yaml.load(configContent) as {
  notebooks: Array<{
    id: string;
    title: string;
    description: string;
    order: number;
  }>;
};

// Load manifest
let latestDate = 'No data yet';
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
if (fs.existsSync(manifestPath)) {
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  latestDate = manifest.latest_date || latestDate;
}

const notebooks = config.notebooks.sort((a, b) => a.order - b.order);

const formatDate = (dateStr: string) => {
  if (dateStr === 'No data yet') return dateStr;
  const date = new Date(dateStr + 'T00:00:00Z');
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    month: 'long',
    day: 'numeric',
    year: 'numeric',
    timeZone: 'UTC'
  });
};
---

<BaseLayout title="Home">
  <div class="max-w-3xl">
    <!-- Hero Section -->
    <header class="mb-16 animate-[fadeUp_0.6s_ease-out]">
      <div class="inline-flex items-center gap-2 font-mono text-[0.6875rem] uppercase tracking-widest text-muted-foreground bg-muted py-1.5 px-3 rounded-full mb-6">
        <span class="w-1.5 h-1.5 bg-accent rounded-full animate-pulse"></span>
        <span>Updated {formatDate(latestDate)}</span>
      </div>
      <h1 class="font-serif text-5xl font-normal leading-tight -tracking-wide m-0 mb-6 max-md:text-4xl">
        <span class="block text-foreground">Ethereum P2P</span>
        <span class="block bg-gradient-to-br from-primary to-accent bg-clip-text text-transparent">Network Analysis</span>
      </h1>
      <p class="text-lg leading-relaxed text-muted-foreground max-w-xl">
        Real-time insights into Ethereum's peer-to-peer layer. Tracking blob propagation,
        node connectivity, and network health across the mainnet.
      </p>
    </header>

    <!-- Notebooks Grid -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-6">
        <h2 class="font-serif text-2xl font-normal -tracking-tight m-0">Latest Analysis</h2>
        <span class="font-mono text-[0.625rem] uppercase tracking-wide text-muted-foreground bg-muted py-1 px-2.5 rounded-full">{notebooks.length} notebooks</span>
      </div>
      <div class="flex flex-col gap-3 reveal-stagger">
        {notebooks.map((nb, index) => (
          <a
            href={`/notebooks/${nb.id}`}
            class="group flex items-center gap-4 p-5 bg-card border border-border rounded-lg no-underline transition-all duration-200 hover:border-primary hover:translate-x-1 hover:shadow-[-4px_0_0_var(--primary)] dark:hover:bg-[oklch(0.16_0.02_260)] dark:hover:shadow-[-4px_0_0_var(--primary),var(--glow)]"
            style={`--index: ${index}`}
          >
            <div class="flex items-center justify-center w-10 h-10 bg-muted rounded-lg text-muted-foreground shrink-0 transition-all duration-200 group-hover:bg-primary group-hover:text-primary-foreground">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <polyline points="14 2 14 8 20 8" />
                <line x1="16" y1="13" x2="8" y2="13" />
                <line x1="16" y1="17" x2="8" y2="17" />
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="font-sans text-[0.9375rem] font-semibold text-foreground m-0 mb-1 leading-tight">{nb.title}</h3>
              <p class="text-[0.8125rem] text-muted-foreground m-0 leading-normal">{nb.description}</p>
            </div>
            <div class="text-muted-foreground opacity-0 -translate-x-2 transition-all duration-200 group-hover:opacity-100 group-hover:translate-x-0 group-hover:text-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </div>
          </a>
        ))}
      </div>
    </section>

    <!-- Info Grid -->
    <section class="mb-16">
      <div class="grid grid-cols-3 gap-5 max-md:grid-cols-1">
        <div class="p-6 bg-card border border-border rounded-lg transition-all duration-200 hover:border-[var(--mauve-6)] dark:hover:bg-[oklch(0.16_0.02_260)]">
          <div class="flex items-center justify-center w-9 h-9 bg-muted rounded-lg text-primary mb-4">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
          </div>
          <h3 class="font-sans text-sm font-semibold text-foreground m-0 mb-2">Daily Updates</h3>
          <p class="text-[0.8125rem] text-muted-foreground m-0 leading-relaxed">Notebooks regenerate automatically at 1am UTC with fresh data from the previous day.</p>
        </div>

        <div class="p-6 bg-card border border-border rounded-lg transition-all duration-200 hover:border-[var(--mauve-6)] dark:hover:bg-[oklch(0.16_0.02_260)]">
          <div class="flex items-center justify-center w-9 h-9 bg-muted rounded-lg text-primary mb-4">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <ellipse cx="12" cy="5" rx="9" ry="3"/>
              <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
              <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
            </svg>
          </div>
          <h3 class="font-sans text-sm font-semibold text-foreground m-0 mb-2">Data Source</h3>
          <p class="text-[0.8125rem] text-muted-foreground m-0 leading-relaxed">Powered by EthPandaOps Xatu infrastructure, querying ClickHouse for network-wide metrics.</p>
        </div>

        <div class="p-6 bg-card border border-border rounded-lg transition-all duration-200 hover:border-[var(--mauve-6)] dark:hover:bg-[oklch(0.16_0.02_260)]">
          <div class="flex items-center justify-center w-9 h-9 bg-muted rounded-lg text-primary mb-4">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M12 20V10"/>
              <path d="M18 20V4"/>
              <path d="M6 20v-4"/>
            </svg>
          </div>
          <h3 class="font-sans text-sm font-semibold text-foreground m-0 mb-2">Historical Archive</h3>
          <p class="text-[0.8125rem] text-muted-foreground m-0 leading-relaxed">All historical snapshots are preserved and accessible. Track trends over time via the sidebar.</p>
        </div>
      </div>
    </section>

    <!-- Pipeline Section -->
    <section class="p-8 bg-muted rounded-lg dark:bg-[oklch(0.14_0.02_260)]">
      <h2 class="font-serif text-xl font-normal -tracking-tight m-0 mb-6 text-center">Data Pipeline</h2>
      <div class="flex items-center justify-center gap-2 flex-wrap max-md:flex-col">
        <div class="flex flex-col items-center gap-2">
          <div class="flex items-center justify-center w-11 h-11 bg-background border border-border rounded-lg text-muted-foreground transition-all duration-200">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <ellipse cx="12" cy="5" rx="9" ry="3"/>
              <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
              <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
            </svg>
          </div>
          <span class="font-mono text-[0.625rem] uppercase tracking-wide text-muted-foreground">ClickHouse</span>
        </div>
        <div class="text-border max-md:rotate-90">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 12h14"/>
            <path d="M12 5l7 7-7 7"/>
          </svg>
        </div>
        <div class="flex flex-col items-center gap-2">
          <div class="flex items-center justify-center w-11 h-11 bg-background border border-border rounded-lg text-muted-foreground transition-all duration-200">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
          </div>
          <span class="font-mono text-[0.625rem] uppercase tracking-wide text-muted-foreground">Parquet</span>
        </div>
        <div class="text-border max-md:rotate-90">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 12h14"/>
            <path d="M12 5l7 7-7 7"/>
          </svg>
        </div>
        <div class="flex flex-col items-center gap-2">
          <div class="flex items-center justify-center w-11 h-11 bg-background border border-border rounded-lg text-muted-foreground transition-all duration-200">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
              <line x1="8" y1="21" x2="16" y2="21"/>
              <line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
          </div>
          <span class="font-mono text-[0.625rem] uppercase tracking-wide text-muted-foreground">Jupyter</span>
        </div>
        <div class="text-border max-md:rotate-90">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 12h14"/>
            <path d="M12 5l7 7-7 7"/>
          </svg>
        </div>
        <div class="flex flex-col items-center gap-2">
          <div class="flex items-center justify-center w-11 h-11 bg-primary border-primary rounded-lg text-primary-foreground transition-all duration-200 dark:shadow-[var(--glow)]">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5"/>
              <path d="M2 12l10 5 10-5"/>
            </svg>
          </div>
          <span class="font-mono text-[0.625rem] uppercase tracking-wide text-primary font-semibold">Visualizations</span>
        </div>
      </div>
    </section>
  </div>
</BaseLayout>
