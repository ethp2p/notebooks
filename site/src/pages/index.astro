---
import BaseLayout from '../layouts/BaseLayout.astro';
import Icon from '../components/Icon.astro';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Load notebooks config from pipeline.yaml
const configPath = path.join(process.cwd(), '..', 'pipeline.yaml');
const configContent = fs.readFileSync(configPath, 'utf-8');
const config = yaml.load(configContent) as {
  notebooks: Array<{
    id: string;
    title: string;
    description: string;
    icon?: string;
    order: number;
  }>;
};

// Load manifest
let latestDate = 'No data yet';
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
if (fs.existsSync(manifestPath)) {
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  latestDate = manifest.latest_date || latestDate;
}

const notebooks = config.notebooks.sort((a, b) => a.order - b.order);

const formatDate = (dateStr: string) => {
  if (dateStr === 'No data yet') return dateStr;
  const date = new Date(dateStr + 'T00:00:00Z');
  return date.toLocaleDateString('en-US', {
    weekday: 'long',
    month: 'long',
    day: 'numeric',
    year: 'numeric',
    timeZone: 'UTC'
  });
};
---

<BaseLayout title="Home">
  <div class="max-w-3xl">
    <!-- Hero Section -->
    <header class="mb-16 animate-[fadeUp_0.6s_ease-out]">
      <div class="inline-flex items-center gap-2 font-mono text-[0.6875rem] uppercase tracking-widest text-muted-foreground bg-muted py-1.5 px-3  mb-6">
        <span class="w-1.5 h-1.5 bg-accent  animate-pulse"></span>
        <span>Updated {formatDate(latestDate)}</span>
      </div>
      <h1 class="font-serif text-5xl font-normal leading-tight -tracking-wide m-0 mb-6 max-md:text-4xl">
        <span class="block text-foreground">Ethereum P2P</span>
        <span class="block bg-gradient-to-br from-primary to-accent bg-clip-text text-transparent">Network Analysis</span>
      </h1>
      <p class="text-lg leading-relaxed text-muted-foreground max-w-xl">
        Real-time insights into Ethereum's peer-to-peer layer. Tracking blob propagation,
        node connectivity, and network health across the mainnet.
      </p>
    </header>

    <!-- Notebooks Grid -->
    <section class="mb-16">
      <div class="flex items-center justify-between mb-6">
        <h2 class="font-serif text-2xl font-normal -tracking-tight m-0">Latest Analysis</h2>
        <span class="font-mono text-[0.625rem] uppercase tracking-wide text-muted-foreground bg-muted py-1 px-2.5 ">{notebooks.length} notebooks</span>
      </div>
      <div class="flex flex-col gap-3 reveal-stagger">
        {notebooks.map((nb, index) => (
          <a
            href={`/notebooks/${nb.id}`}
            class="group flex items-center gap-4 p-5 bg-card border border-border  no-underline transition-all duration-200 hover:border-primary hover:translate-x-1 hover:shadow-[-4px_0_0_var(--primary)] dark:hover:bg-[oklch(0.16_0.02_260)] dark:hover:shadow-[-4px_0_0_var(--primary),var(--glow)]"
            style={`--index: ${index}`}
          >
            <div class="flex items-center justify-center w-10 h-10 bg-muted  text-muted-foreground shrink-0 transition-all duration-200 group-hover:bg-primary group-hover:text-primary-foreground">
              <Icon name={nb.icon || 'FileText'} size={20} />
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="font-sans text-[0.9375rem] font-semibold text-foreground m-0 mb-1 leading-tight">{nb.title}</h3>
              <p class="text-[0.8125rem] text-muted-foreground m-0 leading-normal">{nb.description}</p>
            </div>
            <div class="text-muted-foreground opacity-0 -translate-x-2 transition-all duration-200 group-hover:opacity-100 group-hover:translate-x-0 group-hover:text-primary">
              <Icon name="ChevronRight" size={16} />
            </div>
          </a>
        ))}
      </div>
    </section>
  </div>
</BaseLayout>
