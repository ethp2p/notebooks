---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { NotebookIcon } from '../../components/NotebookIcon';
import { Icon } from '../../components/Icon';
import yaml from 'js-yaml';
import fs from 'node:fs';
import path from 'node:path';

// Helper to convert YYYYMMDD to YYYY-MM-DD
const toIsoDate = (compact: string) =>
  `${compact.slice(0,4)}-${compact.slice(4,6)}-${compact.slice(6,8)}`;

// Helper to convert YYYY-MM-DD to YYYYMMDD
const toCompactDate = (iso: string) => iso.replace(/-/g, '');

// Load notebooks config
const configPath = path.join(process.cwd(), 'config', 'notebooks.yaml');
const configContent = fs.readFileSync(configPath, 'utf-8');
const config = yaml.load(configContent) as {
  notebooks: Array<{
    id: string;
    title: string;
    description: string;
    icon?: string;
    order: number;
  }>;
};

// Load manifest
const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
let manifest: { dates: Record<string, Record<string, unknown>> } = { dates: {} };
if (fs.existsSync(manifestPath)) {
  manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
}

export function getStaticPaths() {
  const manifestPath = path.join(process.cwd(), 'public', 'rendered', 'manifest.json');
  if (!fs.existsSync(manifestPath)) {
    return [];
  }
  const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
  const dates = Object.keys(manifest.dates || {});

  // Return compact date format (YYYYMMDD)
  return dates.map(isoDate => ({
    params: { date: isoDate.replace(/-/g, '') },
    props: { isoDate }
  }));
}

const { date } = Astro.params;
const { isoDate } = Astro.props;

// Use provided isoDate or convert from compact format
const dateIso = isoDate || toIsoDate(date!);
const dateData = manifest.dates[dateIso] || {};
const notebooks = config.notebooks.sort((a, b) => a.order - b.order);

// Filter to notebooks that have been rendered for this date
const availableNotebooks = notebooks.filter(nb => dateData[nb.id]);

// Get all dates for navigation (sorted newest first)
const allDatesIso = Object.keys(manifest.dates).sort((a, b) => b.localeCompare(a));
const currentIndex = allDatesIso.indexOf(dateIso);
const prevDateIso = currentIndex < allDatesIso.length - 1 ? allDatesIso[currentIndex + 1] : null;
const nextDateIso = currentIndex > 0 ? allDatesIso[currentIndex - 1] : null;

// Format date for display
const dateObj = new Date(dateIso + 'T00:00:00Z');
const formattedDate = dateObj.toLocaleDateString('en-US', {
  weekday: 'long',
  month: 'long',
  day: 'numeric',
  year: 'numeric',
  timeZone: 'UTC'
});
const dayOfWeek = dateObj.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'UTC' });
const monthShort = dateObj.toLocaleDateString('en-US', { month: 'short', timeZone: 'UTC' });
const dayNum = dateObj.getDate();
const year = dateObj.getFullYear();

---

<BaseLayout title={`${formattedDate}`}>
  <div class="date-page">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <a href="/" class="breadcrumb-link">
        <Icon name="Home" size={14} />
        <span>Home</span>
      </a>
      <span class="breadcrumb-sep">/</span>
      <span class="breadcrumb-current">{dateIso}</span>
    </nav>

    <!-- Header -->
    <header class="date-header">
      <div class="date-display">
        <div class="date-calendar-badge">
          <span class="date-month">{monthShort}</span>
          <span class="date-day">{dayNum}</span>
          <span class="date-year">{year}</span>
        </div>
        <div class="date-info">
          <span class="date-weekday">{dayOfWeek}</span>
          <h1 class="date-title">Daily Snapshot</h1>
          <p class="date-subtitle">{formattedDate}</p>
        </div>
      </div>
    </header>

    <!-- Notebooks section -->
    <section class="notebooks-section">
      <h2 class="section-title">
        <span class="section-title-text">Analysis Notebooks</span>
        <span class="section-title-line"></span>
      </h2>

      {availableNotebooks.length > 0 ? (
        <div class="notebooks-grid">
          {availableNotebooks.map((nb, index) => (
            <a
              href={`/${date}/${nb.id}`}
              class="notebook-card"
              style={`--delay: ${index * 0.08}s`}
            >
              <div class="notebook-icon">
                <NotebookIcon icon={nb.icon} size={24} />
              </div>
              <div class="notebook-content">
                <h3 class="notebook-title">{nb.title}</h3>
                <p class="notebook-description">{nb.description}</p>
              </div>
              <div class="notebook-arrow">
                <Icon name="ArrowRight" size={18} />
              </div>
              <div class="notebook-glow"></div>
            </a>
          ))}
        </div>
      ) : (
        <div class="empty-state">
          <div class="empty-icon">
            <Icon name="FilePlus" size={48} strokeWidth={1} />
          </div>
          <h3 class="empty-title">No Notebooks Available</h3>
          <p class="empty-text">No analysis notebooks have been rendered for this date.</p>
        </div>
      )}
    </section>

    <!-- Back link -->
    <div class="back-section">
      <a href="/" class="back-link">
        <Icon name="ArrowLeft" size={16} />
        <span>Back to Home</span>
      </a>
    </div>
  </div>
</BaseLayout>

<style>
  @reference "../../styles/global.css";

  .date-page {
    @apply max-w-3xl;
    animation: fadeUp 0.5s ease-out;
  }

  /* Breadcrumb */
  .breadcrumb {
    @apply flex items-center gap-2 mb-8 font-mono text-sm;
  }

  .breadcrumb-link {
    @apply flex items-center gap-1.5 text-muted-foreground no-underline transition-colors duration-200;
  }

  .breadcrumb-link:hover {
    @apply text-foreground;
  }

  .breadcrumb-sep {
    @apply text-border;
  }

  .breadcrumb-current {
    @apply text-foreground font-medium;
  }

  /* Header */
  .date-header {
    @apply mb-3 pb-8;
  }

  .date-display {
    @apply flex items-center gap-5;
  }

  .date-calendar-badge {
    @apply flex flex-col items-center justify-center w-16 h-20  border-2 border-primary bg-primary/5;
    animation: fadeUp 0.4s ease-out 0.1s backwards;
  }

  :global(.dark) .date-calendar-badge {
    @apply bg-primary/10;
  }

  .date-month {
    @apply font-mono text-[0.625rem] font-bold uppercase tracking-wider text-primary;
  }

  .date-day {
    @apply font-serif text-2xl font-normal text-foreground leading-none -tracking-tight;
  }

  .date-year {
    @apply font-mono text-[0.625rem] text-muted-foreground;
  }

  .date-info {
    @apply flex flex-col;
    animation: fadeUp 0.4s ease-out 0.15s backwards;
  }

  .date-weekday {
    @apply font-mono text-[0.625rem] font-semibold uppercase tracking-widest text-primary mb-0.5;
  }

  .date-title {
    @apply font-serif text-2xl font-normal text-foreground m-0 mb-0.5 leading-tight -tracking-wide;
  }

  .date-subtitle {
    @apply font-sans text-sm text-muted-foreground m-0;
  }

  /* Section */
  .notebooks-section {
    @apply mb-12;
    animation: fadeUp 0.4s ease-out 0.35s backwards;
  }

  .section-title {
    @apply flex items-center gap-4 font-serif text-xl font-normal text-foreground m-0 mb-6;
  }

  .section-title-text {
    @apply shrink-0;
  }

  .section-title-line {
    @apply flex-1 h-px bg-border;
  }

  /* Notebooks grid */
  .notebooks-grid {
    @apply flex flex-col gap-3;
  }

  .notebook-card {
    @apply relative flex items-center gap-5 p-5  border border-border bg-card no-underline transition-all duration-250 overflow-hidden;
    animation: fadeUp 0.4s ease-out calc(0.4s + var(--delay)) backwards;
  }

  .notebook-card:hover {
    @apply border-primary -translate-y-0.5;
    box-shadow: 0 8px 30px oklch(0 0 0 / 8%);
  }

  :global(.dark) .notebook-card:hover {
    @apply bg-[oklch(0.16_0.02_260)];
    box-shadow: 0 8px 30px oklch(0.55 0.12 280 / 15%);
  }

  .notebook-icon {
    @apply flex items-center justify-center w-12 h-12  bg-primary/10 text-primary shrink-0 transition-all duration-250;
  }

  .notebook-card:hover .notebook-icon {
    @apply bg-primary text-primary-foreground scale-110;
  }

  .notebook-content {
    @apply flex-1 min-w-0;
  }

  .notebook-title {
    @apply font-serif text-lg font-normal text-foreground m-0 mb-1 leading-snug;
  }

  .notebook-description {
    @apply text-sm text-muted-foreground m-0 leading-relaxed line-clamp-2;
  }

  .notebook-arrow {
    @apply flex items-center justify-center w-10 h-10  text-muted-foreground opacity-0 -translate-x-2 transition-all duration-250;
  }

  .notebook-card:hover .notebook-arrow {
    @apply opacity-100 translate-x-0 text-primary;
  }

  .notebook-glow {
    @apply absolute inset-0 opacity-0 transition-opacity duration-300 pointer-events-none;
    background: radial-gradient(circle at 50% 50%, oklch(0.6 0.15 280 / 8%) 0%, transparent 70%);
  }

  .notebook-card:hover .notebook-glow {
    @apply opacity-100;
  }

  /* Empty state */
  .empty-state {
    @apply text-center py-16 px-8  bg-muted/50 border border-border;
  }

  .empty-icon {
    @apply inline-flex text-muted-foreground opacity-40 mb-6;
  }

  .empty-title {
    @apply font-serif text-xl font-normal text-foreground m-0 mb-2;
  }

  .empty-text {
    @apply text-sm text-muted-foreground m-0;
  }

  /* Back section */
  .back-section {
    @apply pt-8 border-t border-border;
    animation: fadeUp 0.4s ease-out 0.5s backwards;
  }

  .back-link {
    @apply inline-flex items-center gap-2 font-mono text-sm text-muted-foreground no-underline transition-colors duration-200;
  }

  .back-link:hover {
    @apply text-foreground;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .date-display {
      @apply gap-4;
    }

    .date-calendar-badge {
      @apply w-14 h-16;
    }

    .date-day {
      @apply text-xl;
    }

    .date-title {
      @apply text-xl;
    }

    .notebook-card {
      @apply p-4 gap-4;
    }

    .notebook-icon {
      @apply w-10 h-10;
    }
  }
</style>
